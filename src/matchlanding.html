<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link href="https://evofitness.no/assets/evo-theme/default/favicon-9430b57a7f69d576bddb2eafe57df145.png" rel="shortcut icon" type="image/vnd.microsoft.icon">
	<link rel="stylesheet" type="text/css" href="CSS/style.css">
	<link rel="stylesheet" type="text/css" href="CSS/bootstrap.css">
	<link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=PT+Sans:400,400i,700,700i" rel="stylesheet">
	<meta name="description" content="Finn din EVO Buddy - I denne tjenesten matcher vi deg med potensielle treningspartnere som har det samme nettverket og interessene som du har." />
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
	<script src="//netdna.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
	<title>EVO Buddy</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	
	<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-63150093-5', 'auto');
  ga('send', 'pageview');

</script>
	
	<script>
		all_users = [];
		inviteable_friends = [];
		authObject = null;
		me = null;

		$(function () {
			$("input[name=gender]:radio").change(function () {
				build_list();
			});
            $("#log-out-button").on('click', function(){
                FB.logout(function (response) {
                    if (window.location.hostname === "evobuddy.no"){
                        window.location.href = "/";
                    }
                    else {
                        window.location.href = ("https://apps.facebook.com/392707531064268/");
                    }
                });
            });
            $(".js-invite-button").on('click', function(){
                if (!$(this).data('isFake')){
                    FB.ui({
                        method: 'send',
                        link: 'http://info.evofitness.no/workout-buddy/',
                        to: $(this).data("id")
                    });
                }
                else{
                    FB.ui({
                        method: 'apprequests',
                        message: "You have been invited by " + me.name,
                        to: $(this).data("id")
                    }, function (resp) {
                        console.log(resp);
                    });
                }
            });
            $("#refer-code").on("input", function(){
                $('#textarea-copy').val("Hei! Vil du bli min EVO Buddy? Trening med en venn er både hyggelig og motiverende, og jeg vil gjerne trene sammen med deg. Bruk koden " + $(this).val() + " så får du et uforpliktende medlemskap hos EVO for kun 99,- ut februar. I tillegg får vi en gratis DUO-time hos en personlig trener, som gir oss en kjempegod start. Blir du med?");
            });
            $("#textarea-copy").on('keypress', function(e){
                e.preventDefault();
            });
            $(".js-copy-button").on('click', function(){
                $('#textarea-copy').select();
                try {
                    var successful = document.execCommand('copy');
                    var msg = successful ? 'successful' : 'unsuccessful';
                } catch (err) {
                }

            });
		});
		function fixUser(user, likes) {

            if (typeof(likes) === 'undefined'){
                user.isFake = true;
            }

            else{
                user.isFake = false;
            }

            user.nice_gender = "unkown";

            if (user.gender === "male"){
                user.nice_gender = "mann";

            }
            else if (user.gender === "female"){
                user.nice_gender = "kvinne";
            }

			user.same_likes = [];
			user.location = (typeof user.location === 'undefined') ? null : user.location;

			if (user.location && me.location && me.location.location.latitude && me.location.location.longitude && user.location.location.latitude && user.location.location.longitude) {
				user.distance = get_distance(me.location.location.latitude, me.location.location.longitude, user.location.location.latitude, user.location.location.longitude);
			}

			user.likes = likes;

			if (!likes) {
				user.matchPercent = 0;
			} else {
				user.matchPercent = get_match_percentage(user);
			}

			return user;
		}

		function get_match_percentage(user) {
			var likes = me.likes.length;
			var mul = 0.25;
			var same_likes = 0;


			for (var i = 0; i < user.likes.length; i++) {
				for (var i2 = 0; i2 < me.likes.length; i2++) {
					if (user.likes[i].id === me.likes[i2].id) {
						same_likes++;
						user.same_likes.push(user.likes[i].name);
					}
				}
			}

            var distance_penalty = 40

            if (user.distance){
                distance_penalty = user.distance / 1000
            }
			
			var gem = (same_likes / me.likes.length) * 100;
			var multiplikator = 1 + mul * same_likes;

			return Math.max(Math.min(Math.ceil((gem * multiplikator) + (20 - distance_penalty )), 100), 0);
		}

		function get_distance(lat1, lon1, lat2, lon2) {
			var R = 6371e3;
			var φ1 = lat1 * Math.PI / 180;
			var φ2 = lat2 * Math.PI / 180;
			var Δφ = (lat2 - lat1) * Math.PI / 180;
			var Δλ = (lon2 - lon1) * Math.PI / 180;

			var a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
				Math.cos(φ1) * Math.cos(φ2) *
				Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
			var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
			var d = R * c;
			return d
		}

		function filter_list() {
			var users = all_users.filter(function (value) {
				var gender = $('input[name=gender]:checked').val();
				if (gender === "both") {
					return true
				} else {
					return value.gender === gender
				}

			});

			return users.sort(function (a, b) {
				if (a.matchPercent < b.matchPercent)
					return 1;
				if (a.matchPercent > b.matchPercent)
					return -1;
				return 0;

			})
		}

		function build_list() {
			$(".matchcontainer").empty();
			filter_list().forEach(function (user) {
				var $newPerson = $("<div class='col-xs-12 matchrow'> \
                                 <div class='col-xs-12' style='padding-bottom:3%; padding-left: 0; padding-right: 0px!important;'> \
                                 <div class='col-xs-7 col-sm-9' style='padding-left: 0;'> \
                                 <h3>" + user.name + "</h3> \
                                 </div> \
                                 <div class='col-xs-5 col-sm-3' style='padding-right: 0px!important;'> \
                                 <h5>Så bra matcher dere:</h5> \
                                 </div></div> \
                                 <img class='col-xs-3 profileimgsmall' src=" + user.picture.data.url + "> \
                                 <div class='col-xs-6' style='padding-top: 2%;padding-left: 4%;'> \
                                 <h5 style='margin-top: 15px!important;' class > Kjønn: " + user.nice_gender + "</h5> \
                                 <h5 style='margin-top: 15px!important;'>Felles interesser:</h5> \
                                 <h5 style='margin-top: 15px!important;'> " + user.same_likes.slice(0, 2) + " </h5> \
                                 </div> \
                                 <div class='col-xs-3'> \
                                 <h3 class='matchpercent'>" + user.matchPercent + "%</h3> \
                                 <button class='ctabuttonsmall hidden-xs visible-sm visible-md visible-lg' data-popup-open='popup-match'>Finn ut mer</button> \
                                 </div> \
                                 <div class='col-xs-12' style='padding:0px; margin-left: 15px;'> \
                                 <button style='float: right;margin-bottom: 15px; width: 77%;' class='ctabuttonsmall visible-xs hidden-sm hidden-md hidden-lg' data-popup-open='popup-match'>Finn ut mer</button> \
                                 </div>");
				$newPerson.find('.ctabuttonsmall').data('person-data', user);
				$(".matchcontainer").append($newPerson);
			});
		}
		function pushUser(user) {
			all_users.push(user);
			build_list();
		}
		window.fbAsyncInit = function () {
			FB.init({
				appId:'392707531064268',
				xfbml: true,
				version: 'v2.8'
			});
			FB.AppEvents.logPageView();
			FB.getLoginStatus(function (response) {
				if (response.status === "connected" && false) {
					authObject = response.authResponse;
				} else {
					FB.login(function (response) {
						if (response.status === "connected") {
							var authObject = response.authResponse;
							FB.api("/me?fields=name,picture.type(large),gender,birthday,location.fields(location)",
								function (me_response) {
									me = me_response;
									$("#profile_picture").attr(
										"src",
										me.picture.data.url)
									FB.api('/' + authObject.userID + "/likes?limit=100",
										function (likes_response) {
											me.likes = likes_response.data;
										});
									FB.api(
										"/" + authObject.userID + "/friends?fields=name,gender,birthday,picture.type(large),location.fields(location),about",
										function (response) {
											response.data.forEach(function (user) {
												FB.api('/' + user.id + "/likes?limit=100",
													function (likes_response) {
														user = fixUser(user, likes_response.data);
														pushUser(user);
													});
											});
										});
								});
							FB.api(
								"/" + authObject.userID + "/invitable_friends?fields=name,picture.type(large)",
								function (response) {
									if (response && !response.error) {
										response.data.forEach(function (user) {
											user = fixUser(user);
											pushUser(user);
										});
									}
								});
						}
					}, {
						scope: ["user_friends", "user_location", "user_hometown", "user_likes"]
					});
				}
			});
		};
		(function (d, s, id) {
			var js, fjs = d.getElementsByTagName(s)[0];
			if (d.getElementById(id)) {
				return;
			}
			js = d.createElement(s);
			js.id = id;
			js.src = "https://connect.facebook.net/en_US/sdk.js";
			fjs.parentNode.insertBefore(js, fjs);
		}(document, 'script', 'facebook-jssdk'));
	</script>
</head>

<body>
	<div class="container-fluid" style="padding:0;">
		<div class="container" style="padding:0;">
        <div class="text-right col-xs-8 col-xs-offset-2 col-sm-4 col-sm-offset-8" style="padding: 1% 0% 1% 0%">
            <button id="log-out-button" class="ctabutton" style="margin-bottom: 25px;padding: 15px 30px!important;font-size: 18px!important;">Logg ut</button>
        </div></div>
		<div class="container" style="display:block;">
			<div class="col-xs-12 col-sm-8 pull-right" style="padding: 5% 4% 3% 4%;">
				<h1 style="text-transform: none;">DINE POTENSIELLE TRENINGSPARTNERE</h1>
			</div>

			<div class="col-xs-10 col-xs-offset-1 col-sm-offset-0 col-sm-4 pull-left" style="padding-top:5%; padding:30px;margin-bottom:-100px;">
				<img id="profile_picture" class="profileimgbig">
			</div>

		</div>
	</div>

	<div class="container-fluid" style="background:#d5d5d5; padding-bottom: 3%;">
		<div class="container" style="display:block; padding:5% 0% 0% 0%;">

			<div class="col-xs-12 col-sm-8 pull-right matchcontainer">

			</div>

			<div class="col-xs-12 col-sm-4 pull-left" id="sidebar" style="padding:0px 30px 50px 30px;">
				<h3 style="margin-top: 50px;">Filter</h3>

				<input type="radio" name="gender" value="male">
				<h5 style="padding-left:2%; display: inline-block;"> Menn</h5>
				<br>
				<input type="radio" name="gender" value="female">
				<h5 style="padding-left:2%; display: inline-block;margin-top: 10px!important;">Kvinner</h5>
				<br>
				<input type="radio" name="gender" value="both" checked>
				<h5 style="padding-left:2%; display: inline-block;margin-top: 10px!important;"> Begge</h5>
				<br>
			</div>

		</div>
	</div>

	<div class="container-fluid text-center" style="padding:0px; background:#dedede; position:fixed; bottom:0px; width:100%; margin-top:90px; z-index: 1004;">
		<img src="images/evologosmall.png" style="padding:25px;">
	</div>

	<!-- POPUP start -->

	<div class="popup" data-popup="popup-match">
		<div class="popup-inner-cover">

			<div class="container-fluid" style="padding:0% 0% 4% 0%; min-height:100%;">
				<div class="container text-center" style="padding: 5% 5% 8% 5%;">
					<h1 class="matchpercent js-match-percent"></h1>
					<div class="col-xs-12 col-sm-10 col-sm-offset-1 col-md-8 col-md-offset-2">
						<p style="margin-top: 30px; margin-bottom: 30px;" class="js-match-text">Gratulerer! Du og din potensielle treningspartner har mange felles interesser. Derfor har vi stor tro på at dere kommer til å lykkes med treningen, sammen. Nå gjenstår det bare for deg å knytte kontakt med din match. Lykke til!</p>
					</div>
                    <div class="col-xs-12 col-sm-10 col-sm-offset-1" style="padding: 0%;margin-top:5%;">
                        <div class="col-xs-12 col-sm-7" style="padding: 3% 0% 3% 0%;">
                        <p class="small" style="text-align:left;">Gå til din medlemside på <a href="https://me.evofitness.no/login" target="_blank">EVOfitness.no</a> og hent din vervekode som gir deg en måned gratis trening, eller fortsett uten dersom du bare vil invitere din nye EVO buddy med et medlemskap for 99kr ut februar.</p>
                        </div>
                        <div class="col-xs-12" style="padding: 0%;">
                        <div class="col-xs-10 col-sm-8 col-md-4" style="background:#ffffff;padding:40px;padding:40px; margin-top:30px margin-bottom:30px;">
                        <input type="text" id="refer-code" value="XXXXX" style="color:#474747!important;text-align:center;font-size:20px!important;">
                        </div>
                    </div>
                    <div class="col-xs-12 col-sm-7" style="padding: 3% 0% 3% 0%;">
                        <p class="small" style="text-align:left;">Kopier teksten (som du selvsagt kan endre om du vil) og klikk på «Inviter EVO Buddy» knappen.</p>
                    </div>
                    <div class="col-xs-12" style="background:#ffffff;padding:40px; margin-top:30px margin-bottom:30px;">
                        <textarea id="textarea-copy" rows="5" style="resize:none;width:100%!important; color:#474747!important;">Hei! Vil du bli min EVO Buddy? Trening med en venn er både hyggelig og motiverende, og jeg vil gjerne trene sammen med deg. Bruk koden xxxxx så får du et uforpliktende medlemskap hos EVO for kun 99,- ut februar. I tillegg får vi en gratis DUO-time hos en personlig trener, som gir oss en kjempegod start. Blir du med?</textarea>
                    </div>
                    <div class="col-xs-12" style="padding: 3% 0% 3% 0%;">
                        <div class="col-xs-12 col-md-4 text-left" style="padding: 0%;">
                        <button class="js-copy-button ctabutton" style="width: 100%;margin-bottom: 20px;">Kopier</button>
                        </div>
                        <div class="col-xs-12 col-xs-offset-0 col-md-7 col-md-offset-1 text-right" style="padding: 0%;">
                        <button class="js-invite-button ctabutton" style="width: 100%;margin-bottom: 20px;">INVITER DIN EVO BUDDY</button>
                    </div>
                    </div>
                    </div>
                    </div>

				<div class="container-fluid" style="background:#d5d5d5; min-height:100%; padding-top:3%;padding-bottom:10%;">
					<div class="container text-center">
						<div class="col-xs-6 text-center" style="padding: 0;">
							<div class="col-xs-10 col-xs-offset-1 text-center">
								<div class="profileimgsmall">
									<img src="" style="width: 100%; height: 100%; border-radius: 50%;" class="js-me-image" alt="">
								</div>
								<h5 style="padding:15px;" class="js-me-text"></h5>
							</div>
						</div>

						<div class="col-xs-6 text-center" style="padding: 0;">
							<div class="col-xs-10 col-xs-offset-1 text-center">
								<div class="profileimgsmall">
									<img src="" style="width: 100%; height: 100%; border-radius: 50%;" class="js-friend-image" alt="">
								</div>
								<h5 style="padding:15px;" class="js-friend-text"></h5>
							</div>
						</div>
					</div>
				</div>

			</div>
			<a class="popup-close" data-popup-close="popup-match" href="#">&times;</a>

		</div>
	</div>
	
	<!--<div class="popup" data-popup="popup-invite">
		<div class="popup-inner-cover">

			<div class="col-xs-8 col-xs-offset-2" style="padding-top:13%; padding-bottom: 3%;">
				<h1>LAG DIN INVITASJON</h1>
				<form method="post" action="">
					<div class="row">
						<div class="col-xs-12">
							<h3>Your name</h3>
							<input type="text" size="100" placeholder="Autofill Name Lastname" style="max-width:100%; width: 100%;">
							<h3>Your e-mail</h3>
							<input type="text" size="100" placeholder="Autofill E-mail" style="max-width:100%; width: 100%; padding-bottom:20px;">
						</div>
					</div>
					<div class="row">
						<div class="col-xs-3 text-center" style="padding-top:3%; padding-right: 4%; padding-bottom: 3%;">
							<div style="width:165px; height:165px; background:#ffffff; border-radius:50%;margin-top:3%;padding:15px;"></div>
						</div>
						<div class="col-xs-9" style="">
							<h3 style="padding-bottom:5px;">Skriv en kort og hyggelig beskjed</h3>
							<textarea rows="4" cols="71" style="max-width:100%; width: 100%;"></textarea>
						</div>
					</div>
					<div class="row">
						<div class="col-xs-12 text-center" style="padding-top: 4%; padding-bottom: 4%;">
							<div class="row">
								<div class="col-xs-12 col-sm-6">
									Gi din nye treningspartner fordelen av å bli med deg på EVO for kun 99,- ut januar.
								</div>
								<div class="col-xs-12 col-sm-6">
									<button class="ctabutton" type="submit" name="submit">SEND INVITASJON</button>
								</div>
							</div>
						</div>
					</div>
				</form>
			</div>
			<a class="popup-close" data-popup-close="popup-invite" href="#">&times;</a>

		</div>
	</div>-->

	<!-- POPUP end -->
	
	<script type="text/javascript">
		(function($){
			$(document.body).on('click', '[data-popup-open]', function (e) {
				var $button = $(this),
					$openPopups = $('.popup:visible'),
					targeted_popup_class = $button.attr('data-popup-open'),
					$popup = $('[data-popup="' + targeted_popup_class + '"]');
				if ($openPopups.length) {
					$openPopups.fadeOut(350, function(){
						$popup.fadeIn(350);
					});
				} else {
					$popup.fadeIn(350);
				}
				
				if ($button.attr('data-popup-open') == 'popup-match') {
					var data = $button.data('person-data');
					$popup.find('.js-match-percent').text(data.matchPercent + '%');
					$popup.find('.js-friend-image').attr('src', data.picture.data.url);
					$popup.find('.js-me-image').attr('src', me.picture.data.url);
					$popup.find('.js-friend-text').text(data.same_likes.join(', '));
					$popup.find('.js-me-text').text(data.same_likes.join(', '));
					$popup.find('.js-invite-button').data('id', data.id);
					$popup.find('.js-invite-button').data('isFake', data.isFake);
					
					$popup.find('.js-match-text').text('Gratulerer! Du og din potensielle treningspartner har en del felles interesser. Vi har tro på at dere kommer til å lykkes med treningen, sammen. Nå gjenstår det bare for deg å knytte kontakt med din match. Lykke til!');
					
					if (data.matchPercent >= 50) {
						$popup.find('.js-match-text').text('Gratulerer! Din potensielle treningspartner har så mye til felles med deg at dere med stor sannsynlighet kjøper morgenkaffen på samme hjørne.');
					}
					if (data.matchPercent >= 60) {
						$popup.find('.js-match-text').text('Gratulerer! Din potensielle treningspartner har så mye til felles med deg at dere med stor sannsynlighet er hektet på samme serie på Netflix.');
					}
					if (data.matchPercent >= 70) {
						$popup.find('.js-match-text').text('Gratulerer! Din potensielle treningspartner har så mye til felles med deg at dere med stor sannsynlighet får energi av den samme musikken.');
					}
					if (data.matchPercent >= 80) {
						$popup.find('.js-match-text').text('Gratulerer! Din potensielle treningspartner har så mye til felles med deg at dere med stor sannsynlighet deler både venner og stamsteder.');
					}
					if (data.matchPercent >= 90) {
						$popup.find('.js-match-text').text('Gratulerer! Din potensielle treningspartner har så mye til felles med deg at dere med stor sannsynlighet allerede er bestevenner.');
					}
				}
				
				e.preventDefault();
			});

			$(document.body).on('click', '[data-popup-close]', function (e) {
				var targeted_popup_class = jQuery(this).attr('data-popup-close');
				$('[data-popup="' + targeted_popup_class + '"]').fadeOut(350);

				e.preventDefault();
			});
		})(jQuery);
	</script>
</body>

</html>
